# 浏览器宏观认识

## 浏览器的架构

### 线程和进程

**线程和进程**：
* 多线程可以并行处理任务，但是线程是不能单独存在的，它是由进程来启动和管理的。
* 一个进程就是一个程序的运行实例。启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，我们把这样的一个运行环境叫进程。

**进程和线程的关系**：

* 线程需要依附于进程，而进程中使用多线程并行处理能提升运算效率。
* 进程中的任意一线程执行出错，都会导致整个进程的崩溃。
* 线程之间共享进程中的数据。
* 当一个进程关闭后，操作系统会回收进程所占用的内存。
* 进程之间的内容相互隔离。

**过去的单进程浏览器**：

* 不稳定。单进程中的插件、渲染线程崩溃导致整个浏览器崩溃。
* 不流畅。脚本（死循环）或插件会使浏览器卡顿。
* 不安全。插件和脚本可以获取到操作系统任意资源。

**现在的多进程浏览器**：

* 解决不稳定。进程相互隔离，一个页面或者插件崩溃时，影响仅仅时当前插件或者页面，不会影响到其他页面。
* 解决不流畅。脚本阻塞当前页面渲染进程，不会影响到其他页面。
* 解决不安全。采用多进程架构使用沙箱。沙箱看成时操作系统给进程上来一把锁，沙箱的程序可以运行，但是不能在硬盘上写入任何数据，也不能在敏感位置读取任何数据。

### Chrome 架构

在《浏览器工作原理与实践》中描述的 Chrome 进程架构如下如所示：

<div style="text-align: center;">
  <img src="./assets/chrome-process-architecture-diagram.png" alt="Chrome 进程架构图" style="width: 560px;">
  <p style="text-align: center; color: #888;">（Chrome 进程架构图，图来源于网络）</p>
</div>

根据实际观察，目前最新的架构又有了很多新的变化，主要是模块分割更加细化了。但大体的进程划分还是如上图所示，包括了：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程。

* **浏览器进程**：主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。
* **渲染进程**：核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。
* **GPU 进程**：GPU 的使用初衷是为了实现 3D CSS 的效果，但随着网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU 进程。
* **网络进程**：主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程。
* **插件进程**：主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

不过目前的这种架构也存在问题：一是资源占用高，二是体系架构复杂。

::: tip 拓展：未来面向服务的架构
李兵老师提到目前 Chrome 官方团队使用**面向服务的架构**思想设计了新的 Chrome 架构。这种架构的特点就是将各种模块重构成独立的服务，每个服务都可以在独立的进程中运行，访问服务必须使用定义好的接口，通过 IPC 来通信，使得系统更内聚、松耦合、易维护和拓展。
:::

## 网络请求协议

> 仅重点介绍在 Web 世界中的 TCP/IP 是如何工作的，更系统的网络协议知识未来会专门针对性地去学习。

### IP：把数据包送达目的主机

互联网中的数据是通过数据包来传输的。如果发送的数据很大，那么该数据就会被拆分为很多小数据包来传输。数据包要在互联网上进行传输，就要符合**网际协议**（Internet Protocol，简称 **IP**）标准。

计算机的地址就称为 IP 地址，访问任何网站实际上只是你的计算机向另外一台计算机请求信息。

以一个数据包从主机 A 到主机 B 的传输过程为例，可以把网络简单分为三层结构，如下图所示：

<div style="text-align: center;">
  <img src="./assets/internet-protocol.png" alt="简化的 IP 网络三层传输模型" style="width: 560px;">
  <p style="text-align: center; color: #888;">（简化的 IP 网络三层传输模型，图来源于网络）</p>
</div>

* 上层将含有「极客时间」的数据包交给网络层。
* 网络层再将 IP 头附加到数据包上，组成新的 **IP 数据包**，并交给底层。
  * IP 头是 IP 数据包开头的信息，包含 IP 版本、源 IP 地址、目标 IP 地址、生存时间等信息。
* 底层通过物理网络将数据包传输给主机 B。
* 数据包被传输到主机 B 的网络层，在这里主机 B 拆开数据包的 IP 头信息，并将拆开来的数据部分交给上层。
* 最终，含有「极客时间」信息的数据包就到达了主机 B 的上层了。

### UDP：把数据包送达应用程序

TODO...
