# Python 协程

## 前置知识

### 并发和并行

* **并发**指的是一个 CPU 同时处理多个程序，但是在同一时间点只会处理其中一个。核心是程序切换的速度非常快，1 秒钟内可以完全很多次程序切换，肉眼无法感知。
* **并行**指的是多个 CPU 同时处理多个程序，同一时间点可以处理多个。

### 同步和异步

* **同步**是执行 IO 操作时，必须等待执行完成才得到返回结果。
* **异步**是执行 IO 操作时，不必等待执行就能得到返回结果。

### 协程的历史

> 协程，英文名是 Coroutine， 又称为微线程，是一种用户态的轻量级线程。协程不像线程和进程那样，需要进行系统内核上的上下文切换，协程的上下文切换是由程序员决定的。在 Python 中协程就是一个可以暂停执行的函数，听起来和生成器的概念一样。

* Python 中协程概念是从 3.4 版本增加的，当时的协程是通过` @asyncio.coroutine` 和 `yield from` 实现的，看起来和生成器的实现方式没什么区别。
* Python 3.5 中，为了更好地将协程和生成器的使用场景进行区分，引入了 `async` 和 `await` 语法糖，用于定义原生协程。
* Python 3.6 中，逐渐稳定，被更多的人认可。
* Python 3.7 官方把 `async` 和 `await` 作为保留字，同时协程的调用也变得简单了许多。但是，正是保留字的原因导致之前很多 `async` 为函数名的库报错，典型的有 scrapy，但解决方法肯定是有的。

### 协程，线程和进程的区别

* 多进程通常利用的是多核 CPU 的优势，同时执行多个计算任务。每个进程有自己独立的内存管理，所以不同进程之间要进行数据通信比较麻烦。
* 多线程是在一个 cpu 上创建多个子任务，当某一个子任务休息的时候其他任务接着执行。多线程的控制是由 Python 自己控制的。子线程之间的内存是共享的，并不需要额外的数据通信机制。但是线程存在数据同步问题，所以要有锁机制。
* 协程的实现是在一个线程内实现的，相当于流水线作业。由于线程切换的消耗比较大，所以对于并发编程，可以优先使用协程。

## 协程的定义

使用协程也就意味着你需要一直写异步方法。在 Python 中我们使用 `asyncio` 模块来实现一个协程。如果我们把 Python 中普通函数称之为同步函数（方法），那么用协程定义的函数我们称之为异步函数（方法）。

> 注意，以下所有的代码实例运行环境均要求版本大于等于 Python3.7。并且会使用 Python 3.7 里面的基础协程用法，现在这种用法已经基本稳定，不太建议使用之前的语法了。

### 同步函数和异步函数的定义

## 协程相对于多线程的优点

多线程编程是比较困难的，因为调度程序任何时候都能中断线程，必须记住保留锁，去保护程序中重要部分，防止多线程在执行的过程中断。

而协程默认会做好全方位保护，以防止中断。我们必须显示产出才能让程序的余下部分运行。对协程来说，无需保留锁，而在多个线程之间同步操作，协程自身就会同步，因为在任意时刻，只有一个协程运行。总结下大概下面几点：

* 无需系统内核的上下文切换，减小开销。
* 无需原子操作锁定及同步的开销，不用担心资源共享的问题。
* 单线程即可实现高并发，单核 CPU 即便支持上万的协程都不是问题，所以很适合用于高并发处理，尤其是在应用在网络爬虫中。

（未完）
