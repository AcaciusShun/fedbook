# TCP 协议

## TCP 包头

TCP 包头比 UDP 复杂得多。

<div style="text-align: center;">
  <svg id="SvgjsSvg1006" width="800" height="396.28749084472656" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs"><defs id="SvgjsDefs1007"></defs><g id="SvgjsG1008" transform="translate(25.000015258789062,24.99999237060547)"><path id="SvgjsPath1009" d="M0 0L371.9745854598999 0L371.9745854598999 46.438641412296185 L0 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1010" d="M371.9745854598999 0L750.0999908447266 0L750.0999908447266 46.438641412296185 L371.9745854598999 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1011"><text id="SvgjsText1012" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="372px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.594320706148093" transform="rotate(0)"><tspan id="SvgjsTspan1013" dy="16" x="186"><tspan id="SvgjsTspan1014" style="text-decoration:;">源端口号（16 位）</tspan></tspan></text></g><g id="SvgjsG1015"><text id="SvgjsText1016" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="379px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.594320706148093" transform="rotate(0)"><tspan id="SvgjsTspan1017" dy="16" x="561.4745854598999"><tspan id="SvgjsTspan1018" style="text-decoration:;">目的端口号（16 位）</tspan></tspan></text></g></g><g id="SvgjsG1019" transform="translate(25.000015258789062,297.29816458505263)"><path id="SvgjsPath1020" d="M0 0L750.0999908447266 0L750.0999908447266 74.30182625967389 L0 74.30182625967389Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1021"><text id="SvgjsText1022" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="751px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="26.525913129836944" transform="rotate(0)"><tspan id="SvgjsTspan1023" dy="16" x="375.5"><tspan id="SvgjsTspan1024" style="text-decoration:;">数据</tspan></tspan></text></g></g><g id="SvgjsG1025" transform="translate(25.000015258789062,70.3241056804091)"><path id="SvgjsPath1026" d="M0 0L750.0999908447266 0L750.0999908447266 46.53151904941949 L0 46.53151904941949Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1027" d="M0 46.53151904941949L750.0999908447266 46.53151904941949L750.0999908447266 93.06303809883897 L0 93.06303809883897Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1028"><text id="SvgjsText1029" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="751px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.640759524709743" transform="rotate(0)"><tspan id="SvgjsTspan1030" dy="16" x="375.5"><tspan id="SvgjsTspan1031" style="text-decoration:;">序号（32 位）</tspan></tspan></text></g><g id="SvgjsG1032"><text id="SvgjsText1033" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="751px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="59.17227857412923" transform="rotate(0)"><tspan id="SvgjsTspan1034" dy="16" x="375.5"><tspan id="SvgjsTspan1035" style="text-decoration:;">确认序号（32 位）</tspan></tspan></text></g></g><g id="SvgjsG1036" transform="translate(25.000015258789062,163.47101054844387)"><path id="SvgjsPath1037" d="M0 0L113.71515861206056 0L113.71515861206056 46.438641412296185 L0 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1038" d="M113.71515861206056 0L219.55426732025148 0L219.55426732025148 46.438641412296185 L113.71515861206056 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1039" d="M219.479257321167 0L245.05766700897217 0L245.05766700897217 46.438641412296185 L219.479257321167 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1040" d="M245.05766700897217 0L269.2108867141724 0L269.2108867141724 46.438641412296185 L245.05766700897217 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1041" d="M269.2858967132568 0L296.0644663864136 0L296.0644663864136 46.438641412296185 L269.2858967132568 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1042" d="M296.0644663864136 0L322.46798606414796 0L322.46798606414796 46.438641412296185 L296.0644663864136 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1043" d="M322.46798606414796 0L349.0215257400513 0L349.0215257400513 46.438641412296185 L322.46798606414796 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1044" d="M349.0215257400513 0L373.84983543701173 0L373.84983543701173 46.438641412296185 L349.0215257400513 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1045" d="M373.9248454360962 0L750.0999908447266 0L750.0999908447266 46.438641412296185 L373.9248454360962 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1046"><text id="SvgjsText1047" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="114px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.594320706148093" transform="rotate(0)"><tspan id="SvgjsTspan1048" dy="16" x="57"><tspan id="SvgjsTspan1049" style="text-decoration:;">首部长度（4 位）</tspan></tspan></text></g><g id="SvgjsG1050"><text id="SvgjsText1051" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="106px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.594320706148093" transform="rotate(0)"><tspan id="SvgjsTspan1052" dy="16" x="166.71515861206058"><tspan id="SvgjsTspan1053" style="text-decoration:;">保留（6 位）</tspan></tspan></text></g><g id="SvgjsG1054"><text id="SvgjsText1055" font-family="微软雅黑" text-anchor="middle" font-size="12px" width="26px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="12px" weight="400" font-style="" opacity="1" y="-1.7806792938519074" transform="rotate(0)"><tspan id="SvgjsTspan1056" dy="15" x="232.479257321167"><tspan id="SvgjsTspan1057" style="text-decoration:;">U</tspan></tspan><tspan id="SvgjsTspan1058" dy="15" x="232.479257321167"><tspan id="SvgjsTspan1059" style="text-decoration:;font-size: inherit;">R</tspan></tspan><tspan id="SvgjsTspan1060" dy="15" x="232.479257321167"><tspan id="SvgjsTspan1061" style="text-decoration:;">G</tspan></tspan></text></g><g id="SvgjsG1062"><text id="SvgjsText1063" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="25px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-3.9056792938519074" transform="rotate(0)"><tspan id="SvgjsTspan1064" dy="16" x="257.5576670089722"><tspan id="SvgjsTspan1065" style="text-decoration:;">A</tspan></tspan><tspan id="SvgjsTspan1066" dy="16" x="257.5576670089722"><tspan id="SvgjsTspan1067" style="text-decoration:;font-size: inherit;">C</tspan></tspan><tspan id="SvgjsTspan1068" dy="16" x="257.5576670089722"><tspan id="SvgjsTspan1069" style="text-decoration:;">K</tspan></tspan></text></g><g id="SvgjsG1070"><text id="SvgjsText1071" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="27px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-3.9056792938519074" transform="rotate(0)"><tspan id="SvgjsTspan1072" dy="16" x="282.7858967132568"><tspan id="SvgjsTspan1073" style="text-decoration:;">P</tspan></tspan><tspan id="SvgjsTspan1074" dy="16" x="282.7858967132568"><tspan id="SvgjsTspan1075" style="text-decoration:;">S</tspan></tspan><tspan id="SvgjsTspan1076" dy="16" x="282.7858967132568"><tspan id="SvgjsTspan1077" style="text-decoration:;">H</tspan></tspan></text></g><g id="SvgjsG1078"><text id="SvgjsText1079" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="27px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-3.9056792938519074" transform="rotate(0)"><tspan id="SvgjsTspan1080" dy="16" x="309.5644663864136"><tspan id="SvgjsTspan1081" style="text-decoration:;">R</tspan></tspan><tspan id="SvgjsTspan1082" dy="16" x="309.5644663864136"><tspan id="SvgjsTspan1083" style="text-decoration:;">S</tspan></tspan><tspan id="SvgjsTspan1084" dy="16" x="309.5644663864136"><tspan id="SvgjsTspan1085" style="text-decoration:;">T</tspan></tspan></text></g><g id="SvgjsG1086"><text id="SvgjsText1087" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="27px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-3.9056792938519074" transform="rotate(0)"><tspan id="SvgjsTspan1088" dy="16" x="335.96798606414796"><tspan id="SvgjsTspan1089" style="text-decoration:;">S</tspan></tspan><tspan id="SvgjsTspan1090" dy="16" x="335.96798606414796"><tspan id="SvgjsTspan1091" style="text-decoration:;">Y</tspan></tspan><tspan id="SvgjsTspan1092" dy="16" x="335.96798606414796"><tspan id="SvgjsTspan1093" style="text-decoration:;">N</tspan></tspan></text></g><g id="SvgjsG1094"><text id="SvgjsText1095" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="25px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-3.9056792938519074" transform="rotate(0)"><tspan id="SvgjsTspan1096" dy="16" x="361.5215257400513"><tspan id="SvgjsTspan1097" style="text-decoration:;">F</tspan></tspan><tspan id="SvgjsTspan1098" dy="16" x="361.5215257400513"><tspan id="SvgjsTspan1099" style="text-decoration:;">I</tspan></tspan><tspan id="SvgjsTspan1100" dy="16" x="361.5215257400513"><tspan id="SvgjsTspan1101" style="text-decoration:;">N</tspan></tspan></text></g><g id="SvgjsG1102"><text id="SvgjsText1103" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="377px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.594320706148093" transform="rotate(0)"><tspan id="SvgjsTspan1104" dy="16" x="562.4248454360961"><tspan id="SvgjsTspan1105" style="text-decoration:;">窗口大小（16 位）</tspan></tspan></text></g></g><g id="SvgjsG1106" transform="translate(25.000015258789062,209.44526554661707)"><path id="SvgjsPath1107" d="M0 0L375.0499954223633 0L375.0499954223633 46.438641412296185 L0 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1108" d="M375.0499954223633 0L750.0999908447266 0L750.0999908447266 46.438641412296185 L375.0499954223633 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1109"><text id="SvgjsText1110" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="376px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.594320706148093" transform="rotate(0)"><tspan id="SvgjsTspan1111" dy="16" x="188"><tspan id="SvgjsTspan1112" style="text-decoration:;">校验和（16 位）</tspan></tspan></text></g><g id="SvgjsG1113"><text id="SvgjsText1114" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="376px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.594320706148093" transform="rotate(0)"><tspan id="SvgjsTspan1115" dy="16" x="563.0499954223633"><tspan id="SvgjsTspan1116" style="text-decoration:;">紧急指针（16 位）</tspan></tspan></text></g></g><g id="SvgjsG1117" transform="translate(25.000015258789062,254.96414322710132)"><path id="SvgjsPath1118" d="M0 0L750.0999908447266 0L750.0999908447266 46.438641412296185 L0 46.438641412296185Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1119"><text id="SvgjsText1120" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="751px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="12.594320706148093" transform="rotate(0)"><tspan id="SvgjsTspan1121" dy="16" x="375.5"><tspan id="SvgjsTspan1122" style="text-decoration:;">选项</tspan></tspan></text></g></g></svg>
  <p style="text-align: center; color: #888;">（TCP 包头示意图）</p>
</div>

* **源端口号**和**目标端口号**：可以知道把数据发给哪个应用。
* **包的序号**：为了解决乱序的问题。
* **确认序号**：为了解决丢包的问题。确认发出去的包对方有没有收到，如果没有收到就重新发送，直到送达。
* **一些状态位**：TCP 是面向连接的，因而双方要维护连接的状态，这些带状态位的包的发送，会引起双方的状态变更。例如 SYN（synchronous）是发起一个连接，ACK（acknowledgement）是确认，PSH（push）是传送，FIN（finish）是结束连接，RST（reset）是重新连接，URG（urgent）是紧急等。
* **窗口大小**：TCP 要做流量控制，通信双方各声明一个窗口，标识自己当前能够的处理能力，防止发送的太快或太慢。

总的来说，TCP 是尽可能地在自己的层面上保证可靠性。因为如果更底层的 IP 层面网络状况就很差，那么是没有任何可靠性保证的。对于 TCP 来说，就是 IP 层你丢不丢包，我管不着，但在我的层面上，可以通过不断重传，通过各种算法，努力保证可靠性。

## TCP 的三次握手

### 状态变化时序图

TCP 的连接建立，常常称为三次握手。在连接建立的过程中，双方的状态变化时序图就像这样：

<div style="text-align: center;">
  <svg id="SvgjsSvg1006" width="608" height="445" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs"><defs id="SvgjsDefs1007"><marker id="SvgjsMarker1059" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1060" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1067" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1068" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1075" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1076" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1083" markerWidth="14" markerHeight="10" refX="4" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1084" d="M14,0 L0,5 L14,10 L14,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1085" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1086" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker></defs><g id="SvgjsG1008" transform="translate(25,65)"><path id="SvgjsPath1009" d="M0 0L140 0L140 40.00773364 L0 40.00773364Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1010" d="M0 40.00773364L140 40.00773364L140 193.04530216 L0 193.04530216Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1011" d="M0 193.00980284L140 193.00980284L140 354.9932 L0 354.9932Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1012"><text id="SvgjsText1013" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6.003866819999999" transform="rotate(0)"><tspan id="SvgjsTspan1014" dy="20" x="70"><tspan id="SvgjsTspan1015" style="text-decoration:;">CLOSED</tspan></tspan></text></g><g id="SvgjsG1016"><text id="SvgjsText1017" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="102.5265179" transform="rotate(0)"><tspan id="SvgjsTspan1018" dy="20" x="70"><tspan id="SvgjsTspan1019" style="text-decoration:;">SYN_SENT</tspan></tspan></text></g><g id="SvgjsG1020"><text id="SvgjsText1021" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="260.00150142" transform="rotate(0)"><tspan id="SvgjsTspan1022" dy="20" x="70"><tspan id="SvgjsTspan1023" style="text-decoration:;">ESTABLISHED</tspan></tspan></text></g></g><g id="SvgjsG1024" transform="translate(443,65)"><path id="SvgjsPath1025" d="M0 0L140 0L140 40.01570307 L0 40.01570307Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1026" d="M0 40.01570307L140 40.01570307L140 83.02290549 L0 83.02290549Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1027" d="M0 83.02290549L140 83.02290549L140 244.98619971 L0 244.98619971Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1028" d="M0 244.98619971000002L140 244.98619971000002L140 351.9411 L0 351.9411Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1029"><text id="SvgjsText1030" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6.007851535" transform="rotate(0)"><tspan id="SvgjsTspan1031" dy="20" x="70"><tspan id="SvgjsTspan1032" style="text-decoration:;">CLOSED</tspan></tspan></text></g><g id="SvgjsG1033"><text id="SvgjsText1034" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="47.51930428" transform="rotate(0)"><tspan id="SvgjsTspan1035" dy="20" x="70"><tspan id="SvgjsTspan1036" style="text-decoration:;">LISTEN</tspan></tspan></text></g><g id="SvgjsG1037"><text id="SvgjsText1038" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="150.0045526" transform="rotate(0)"><tspan id="SvgjsTspan1039" dy="20" x="70"><tspan id="SvgjsTspan1040" style="text-decoration:;">SYN_RCVD</tspan></tspan></text></g><g id="SvgjsG1041"><text id="SvgjsText1042" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="284.463649855" transform="rotate(0)"><tspan id="SvgjsTspan1043" dy="20" x="70"><tspan id="SvgjsTspan1044" style="text-decoration:;">ESTABLISHED</tspan></tspan></text></g></g><g id="SvgjsG1045" transform="translate(34,25)"><path id="SvgjsPath1046" d="M 0 0L 120 0L 120 40L 0 40Z" stroke="none" fill="none"></path><g id="SvgjsG1047"><text id="SvgjsText1048" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="120px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6" transform="rotate(0)"><tspan id="SvgjsTspan1049" dy="20" x="60"><tspan id="SvgjsTspan1050" style="text-decoration:;">客户端</tspan></tspan></text></g></g><g id="SvgjsG1051" transform="translate(454,25)"><path id="SvgjsPath1052" d="M 0 0L 120 0L 120 40L 0 40Z" stroke="none" fill="none"></path><g id="SvgjsG1053"><text id="SvgjsText1054" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="120px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6" transform="rotate(0)"><tspan id="SvgjsTspan1055" dy="20" x="60"><tspan id="SvgjsTspan1056" style="text-decoration:;">服务端</tspan></tspan></text></g></g><g id="SvgjsG1057"><path id="SvgjsPath1058" d="M165.49438963502843 105.0746919592489L439.93478426282365 146.5369098526568" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1059)"></path><rect id="SvgjsRect1061" width="71" height="16" x="267.214586948926" y="117.80580090595285" fill="#ffffff"></rect><text id="SvgjsText1062" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="71px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="115.18080090595285" transform="rotate(0)"><tspan id="SvgjsTspan1063" dy="16" x="302.714586948926"><tspan id="SvgjsTspan1064" style="text-decoration:;">SYN, seq=x</tspan></tspan></text></g><g id="SvgjsG1065"><path id="SvgjsPath1066" d="M442.5322515933258 151.1766675636719L167.9000401213799 254.9046611052342" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1067)"></path><rect id="SvgjsRect1069" width="165" height="16" x="222.71614585735284" y="195.04066433445306" fill="#ffffff"></rect><text id="SvgjsText1070" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="165px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="192.41566433445306" transform="rotate(0)"><tspan id="SvgjsTspan1071" dy="16" x="305.21614585735284"><tspan id="SvgjsTspan1072" style="text-decoration:;">SYN, ACK, seq=y, ack=x+1</tspan></tspan></text></g><g id="SvgjsG1073"><path id="SvgjsPath1074" d="M165.4917928161331 259.09022098425464L439.9508845399748 309.44062989762125" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1075)"></path><rect id="SvgjsRect1077" width="150" height="16" x="227.72133867805394" y="276.265425440938" fill="#ffffff"></rect><text id="SvgjsText1078" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="150px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="273.640425440938" transform="rotate(0)"><tspan id="SvgjsTspan1079" dy="16" x="302.72133867805394"><tspan id="SvgjsTspan1080" style="text-decoration:;">ACK, seq=x+1, ack=y+1</tspan></tspan></text></g><g id="SvgjsG1081"><path id="SvgjsPath1082" d="M168.10000000000002 395L439.9 395" stroke="#323232" stroke-width="2" fill="none" marker-start="url(#SvgjsMarker1083)" marker-end="url(#SvgjsMarker1085)"></path><rect id="SvgjsRect1087" width="52" height="16" x="278" y="387" fill="#ffffff"></rect><text id="SvgjsText1088" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="52px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="384.375" transform="rotate(0)"><tspan id="SvgjsTspan1089" dy="16" x="304"><tspan id="SvgjsTspan1090" style="text-decoration:;">数据传输</tspan></tspan></text></g></svg>
  <p style="text-align: center; color: #888;">（三次握手）</p>
</div>

一开始，客户端和服务端都处于 `CLOSED` 状态。

先是服务端主动监听某个端口，处于 `LISTEN` 状态。

* **第一次握手**：客户端主动发起连接 `SYN`，之后处于 `SYN_SENT`（同步已发送）状态。
* **第二次握手**：服务端收到发起的连接，返回 `SYN`，并且 `ACK` 客户端的 `SYN`，之后处于 `SYN_RCVD`（同步收到）状态。
* **第三次握手**：客户端收到服务端发送的 `SYN` 和 `ACK` 之后，发送 `ACK` 的 `ACK`，之后处于 `ESTABLISHED`（已建立连接）状态，因为它一发一收成功了。

最后，服务端收到 `ACK` 的 `ACK` 之后，处于 `ESTABLISHED`（已建立连接）状态，因为它也一发一收了。

::: tip 小贴士
在三次握手过程中：

* `seq` 是数据包本身的序列号，这是为了连接以后传送数据用的。
* `ack` 是对收到的数据包的确认，值是等待接收的数据包的序列号（也就是期望对方继续发送的那个数据包的序列号）。

在传递过程中它们是这样用的：

* 第一次消息：客户端会随机选取一个序列号（`x`）作为自己的初始序号发送给服务端。
* 第二次消息：服务端使用 ACK 对客户端的数据包进行确认，准备接收序列号为 `x+1` 的包，所以 `ack=x+1`。同时告诉客户端自己的初始序列号，就是 `seq=y`。
* 第三次消息：客户端告诉服务端收到了它的确认消息并准备建立连接，客户端自己此条消息的序列号是 `x+1`，所以 `seq=x+1`，而 `ack=y+1` 是表示客户端正准备接收服务端序列号为 `y+1` 的数据包。
:::

### 客户端不发数据

在大部分情况下，客户端和服务端建立了连接之后，客户端就会马上发送数据。

但如果客户端就是不发数据，建立连接后空着。我们在程序设计的时候，可以要求开启 `keepalive` 机制，即使没有真实的数据包，也有探活包。

另外，作为服务端的程序设计者，对于这种长时间不发包的客户端，可以主动关闭，从而空出资源来给其他客户端使用。

### TCP 包序号问题

三次握手除了双方建立连接外，主要还是为了沟通一件事情，就是 **TCP 包的序号的问题**。客户端要告诉服务端，我这边发起的包的序号起始是从哪个号开始的，反之同理。

但是序号不能都从 `1` 开始，因为这样往往会出现冲突。比如建立连接后：

* 客户端发送了 `1`、`2`、`3` 三个包，但是发送 `3` 的时候，中间丢了，或者绕路了，于是重新发送。
* 后来客户端掉线了，重新连上服务端后，序号又从 `1` 开始，然后发送 `2`，此时压根没想发送 `3`。
* 但是上次绕路的那个 `3` 又回来了，发给了服务端。服务端自然认为，这就是下一个包，于是发生了错误。

因而，每个连接都要有不同的序号。这个序号的起始序号是随着时间变化的，可以看成一个 32 位的计数器，每 4ms 加一，如果计算一下，到重复需要 4 个多小时，那个绕路的包早就死翘翘了，因为我们都知道 IP 包头里面有个 TTL，也即生存时间。

::: tip 小贴士
这里引申一个问题，客户端因为某种原因掉线后（比如拔掉网线几秒再插回去），原本的 TCP 连接还存在吗？
:::

## TCP 的四次挥手

四次挥手的目的是为了确保数据能够完成传输，即客户端和服务端之间都完成了该接收和该发送的内容，防止有一方自顾自地中断「合作」。

### 状态变化时序图

TCP 协议专门设计了几个状态来确保断开连接时的稳定性，这个过程的状态时序图如下：

<div style="text-align: center;">
  <svg id="SvgjsSvg1006" width="610.0000305175781" height="550" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs"><defs id="SvgjsDefs1007"><marker id="SvgjsMarker1071" markerWidth="14" markerHeight="10" refX="4" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1072" d="M14,0 L0,5 L14,10 L14,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1073" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1074" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1081" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1082" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1089" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1090" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1097" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1098" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1105" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1106" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker></defs><g id="SvgjsG1008" transform="translate(25.000015258789062,65)"><path id="SvgjsPath1009" d="M0 0L140 0L140 40.01641559999999 L0 40.01641559999999Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1010" d="M0 40.01641559999999L140 40.01641559999999L140 193.04470835999996 L0 193.04470835999996Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1011" d="M0 193.04470835999996L140 193.04470835999996L140 253.02333587999993 L0 253.02333587999993Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1012" d="M0 253.02333587999996L140 253.02333587999996L140 414.97482935999994 L0 414.97482935999994Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1013" d="M0 414.9748293599999L140 414.9748293599999L140 459.9587999999999 L0 459.9587999999999Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1014"><text id="SvgjsText1015" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6.008207799999994" transform="rotate(0)"><tspan id="SvgjsTspan1016" dy="20" x="70"><tspan id="SvgjsTspan1017" style="text-decoration:;">ESTABLISHED</tspan></tspan></text></g><g id="SvgjsG1018"><text id="SvgjsText1019" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="102.53056197999997" transform="rotate(0)"><tspan id="SvgjsTspan1020" dy="20" x="70"><tspan id="SvgjsTspan1021" style="text-decoration:;">FIN_WAIT_1</tspan></tspan></text></g><g id="SvgjsG1022"><text id="SvgjsText1023" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="209.03402211999995" transform="rotate(0)"><tspan id="SvgjsTspan1024" dy="20" x="70"><tspan id="SvgjsTspan1025" style="text-decoration:;">FIN_WAIT_2</tspan></tspan></text></g><g id="SvgjsG1026"><text id="SvgjsText1027" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="309.99908261999997" transform="rotate(0)"><tspan id="SvgjsTspan1028" dy="20" x="70"><tspan id="SvgjsTspan1029" style="text-decoration:;">TIME_WAIT</tspan></tspan><tspan id="SvgjsTspan1030" dy="20" x="70"><tspan id="SvgjsTspan1031" style="text-decoration:;">（等待 2MSL）</tspan></tspan></text></g><g id="SvgjsG1032"><text id="SvgjsText1033" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="423.46681467999986" transform="rotate(0)"><tspan id="SvgjsTspan1034" dy="20" x="70"><tspan id="SvgjsTspan1035" style="text-decoration:;">CLOSED</tspan></tspan></text></g></g><g id="SvgjsG1036" transform="translate(35.00001525878906,25)"><path id="SvgjsPath1037" d="M 0 0L 120 0L 120 40L 0 40Z" stroke="none" fill="none"></path><g id="SvgjsG1038"><text id="SvgjsText1039" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="120px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6" transform="rotate(0)"><tspan id="SvgjsTspan1040" dy="20" x="60"><tspan id="SvgjsTspan1041" style="text-decoration:;">客户端</tspan></tspan></text></g></g><g id="SvgjsG1042" transform="translate(455.00001525878906,25)"><path id="SvgjsPath1043" d="M 0 0L 120 0L 120 40L 0 40Z" stroke="none" fill="none"></path><g id="SvgjsG1044"><text id="SvgjsText1045" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="120px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6" transform="rotate(0)"><tspan id="SvgjsTspan1046" dy="20" x="60"><tspan id="SvgjsTspan1047" style="text-decoration:;">服务端</tspan></tspan></text></g></g><g id="SvgjsG1048" transform="translate(445.00001525878906,65.49199999999996)"><path id="SvgjsPath1049" d="M0 0L140 0L140 120.95114467999998 L0 120.95114467999998Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1050" d="M0 120.95114467999998L140 120.95114467999998L140 193.99812527999998 L0 193.99812527999998Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1051" d="M0 193.99812527999998L140 193.99812527999998L140 411.94833259999996 L0 411.94833259999996Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1052" d="M0 411.94833259999996L140 411.94833259999996L140 457.97479999999996 L0 457.97479999999996Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1053"><text id="SvgjsText1054" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="46.47557233999999" transform="rotate(0)"><tspan id="SvgjsTspan1055" dy="20" x="70"><tspan id="SvgjsTspan1056" style="text-decoration:;">ESTABLISHED</tspan></tspan></text></g><g id="SvgjsG1057"><text id="SvgjsText1058" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="143.47463498" transform="rotate(0)"><tspan id="SvgjsTspan1059" dy="20" x="70"><tspan id="SvgjsTspan1060" style="text-decoration:;">CLOSE_WAIT</tspan></tspan></text></g><g id="SvgjsG1061"><text id="SvgjsText1062" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="288.97322893999996" transform="rotate(0)"><tspan id="SvgjsTspan1063" dy="20" x="70"><tspan id="SvgjsTspan1064" style="text-decoration:;">LAST_ACK</tspan></tspan></text></g><g id="SvgjsG1065"><text id="SvgjsText1066" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="420.96156629999996" transform="rotate(0)"><tspan id="SvgjsTspan1067" dy="20" x="70"><tspan id="SvgjsTspan1068" style="text-decoration:;">CLOSED</tspan></tspan></text></g></g><g id="SvgjsG1069"><path id="SvgjsPath1070" d="M167.70000610351565 87L442.5000061035156 87" stroke="#323232" stroke-width="2" fill="none" marker-start="url(#SvgjsMarker1071)" marker-end="url(#SvgjsMarker1073)"></path><rect id="SvgjsRect1075" width="52" height="16" x="279.1000061035156" y="79" fill="#ffffff"></rect><text id="SvgjsText1076" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="52px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="76.375" transform="rotate(0)"><tspan id="SvgjsTspan1077" dy="16" x="305.1000061035156"><tspan id="SvgjsTspan1078" style="text-decoration:;">数据传输</tspan></tspan></text></g><g id="SvgjsG1079"><path id="SvgjsPath1080" d="M165.0808970237161 105.13690844703217L442.6184823982728 184.15116762840063" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1081)"></path><rect id="SvgjsRect1083" width="68" height="16" x="269.8496897109944" y="136.6440380377164" fill="#ffffff"></rect><text id="SvgjsText1084" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="68px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="134.0190380377164" transform="rotate(0)"><tspan id="SvgjsTspan1085" dy="16" x="303.8496897109944"><tspan id="SvgjsTspan1086" style="text-decoration:;">FIN, seq=p</tspan></tspan></text></g><g id="SvgjsG1087"><path id="SvgjsPath1088" d="M443.6000061035156 189L167.614308642806 255.27613523250017" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1089)"></path><rect id="SvgjsRect1091" width="89" height="16" x="261.1071573731608" y="214.13806761625008" fill="#ffffff"></rect><text id="SvgjsText1092" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="89px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="211.51306761625008" transform="rotate(0)"><tspan id="SvgjsTspan1093" dy="16" x="305.6071573731608"><tspan id="SvgjsTspan1094" style="text-decoration:;">ACK, ack=p+1</tspan></tspan></text></g><g id="SvgjsG1095"><path id="SvgjsPath1096" d="M445.11102863036683 259.10440800138406L167.63166643703818 318.35267039141866" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1097)"></path><rect id="SvgjsRect1099" width="164" height="16" x="224.37134753370253" y="280.72853919640136" fill="#ffffff"></rect><text id="SvgjsText1100" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="164px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="278.10353919640136" transform="rotate(0)"><tspan id="SvgjsTspan1101" dy="16" x="306.37134753370253"><tspan id="SvgjsTspan1102" style="text-decoration:;">FIN, ACK, seq=q, ack=p+1</tspan></tspan></text></g><g id="SvgjsG1103"><path id="SvgjsPath1104" d="M165.03715810374337 322.2426893666745L442.88966370210346 476.4953259266182" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1105)"></path><rect id="SvgjsRect1107" width="89" height="16" x="259.46341090292344" y="391.3690076466463" fill="#ffffff"></rect><text id="SvgjsText1108" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="89px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="388.7440076466463" transform="rotate(0)"><tspan id="SvgjsTspan1109" dy="16" x="303.96341090292344"><tspan id="SvgjsTspan1110" style="text-decoration:;">ACK, ack=q+1</tspan></tspan></text></g></svg>
  <p style="text-align: center; color: #888;">（四次挥手）</p>
</div>

一开始，客户端和服务端都处于 `ESTABLISHED` 状态，双方正常进行数据传输。

* **第一次挥手**：客户端主动发送一个 `FIN`（结束）的报文，告诉服务端我已经没有数据要发送了，随后进入 `FIN_WAIT_1`（终止等待1）状态。
* **第二次挥手**：
  * 服务端收到这个 `FIN`，返回确认报文 `ACK`，随后进入 `CLOSE_WAIT`（关闭等待）状态。
  * 客户端收到确认后，进入 `FIN_WAIT_2`（终止等待2）状态，等待服务器发送释放连接的报文。因为在释放连接请求发送前，客户端需要接收服务端发送的最后的数据。
  * <div style="opacity: 0.4;">异常情况：接下来如果服务端直接断了，则客户端将永远在这个状态。TCP 协议里面并没有对这个状态的处理，但是 Linux 有，可以调整 <code>tcp_fin_timeout</code> 这个参数，设置一个超时时间。</div>
* **第三次挥手**：服务端发送最后的数据后，发送释放连接的报文（`ACK` 和 `FIN`），然后进入 `LAST_ACK`（最后确认）状态，等待客户端确认。
* **第四次挥手**：
  * 客户端收到释放连接的报文后，发出确认报文 `ACK`，表示知道你东西发完了准备结束了，然后进入 `TIME-WAIT`（时间等待）状态。
  * 这个时候客户端不确定最后的这个 `ACK` 有没有被服务端收到，所以 TCP 连接没有立即释放，等待 `2MSL` 时间过后，客户端才会撤销相应的 TCP 连接，进入 `CLOSED` 状态。
  * <div style="opacity: 0.4;">异常情况：服务端没有收到客户端最后发的那个 <code>ACK</code>，则服务端会重发一次释放连接的报文，让客户端再发一次 <code>ACK</code>。中间这个 <code>2MSL</code> 时间要足够长。</div>
  * 服务端在接收到确认后，立即撤销 TCP 连接，进入 `CLOSED` 状态。

::: tip 小贴士
**MSL** 是 **Maximum Segment Lifetime，报文最大生存时间**。它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。因为 TCP 报文是基于 IP 协议的，而 IP 头中有一个 TTL 域，是 IP 数据报可以经过的最大路由数，每经过一个处理他的路由器此值就减 1，当此值为 0 则数据报将被丢弃，同时发送 ICMP 报文通知源主机。协议规定 MSL 为 2 分钟，实际应用中常用的是 30 秒，1 分钟和 2 分钟等。

还有一个异常情况就是，服务端超过了 `2MSL` 的时间，依然没有收到它发的 `FIN` 的 `ACK`，怎么办呢？按照 TCP 的原理，服务端当然还会重发 `FIN`，这个时候客户端再收到这个包之后，干脆就直接发送 `RST`，服务端就知道客户端早就断开了。
:::

### 客户端延迟释放

上面说了 TCP 协议要求客户端最后等待一段时间 `TIME_WAIT` 后再释放，是为了确保最后一个 `ACK` 能够被服务端收到，因为如果服务端没有收到的话，会重新向客户端发一个 `FIN`，随后客户端也重新发一个 `ACK`。

其实这个 `TIME_WAIT` 这个延时存在还有一个原因，就是如果客户端直接释放了，那它的端口就直接空出来了。但是服务端不知道，服务端原来发过的很多包很可能还在路上。如果客户端的端口被一个新的应用占用了，这个新的应用会收到上个连接中服务端发过来的包。虽然序列号是重新生成的，但是这里要上一个双保险，防止产生混乱，因而也需要等足够长的时间，等到原来服务端发送的所有的包都死翘翘，再空出端口来。

（完）
