# 垃圾回收

## 前置概念

### 内存管理

* 内存：由可读写单元组成，表示一片可操作空间。
* 管理：人为的去操作一片空间的申请、使用和释放。
* 内存管理：开发者主动申请空间、使用空间、释放空间。
* 管理流程：申请内存空间 —— 使用内存空间 —— 释放内存空间。

JavaScript 不能像 C 或 C++ 那样由开发者主动调用 API 来完成内存管理。

### 垃圾

* JavaScript 中内存管理是自动的。
* 对象不再被引用时就是垃圾。
* 对象不能**从根上访问到**时就是垃圾（对象不是可达对象 === 垃圾）。

### 可达对象

* 可以访问到的对象就是可达对象（通过引用、作用域链可以查找到）。
* 可达的标准就是从根出发是否能够被找到。
* JavaScript 中的根可以理解为是全局变量对象（全局执行上下文）。

## GC 算法

### GC 里的垃圾

GC 是垃圾回收机制的简写，它可以查找内存中的垃圾、释放空间和回收空间。在 GC 中，有两种判定为垃圾的标准（当作垃圾 ≠ 被回收）：

* 程序中不再需要使用的对象

```javascript
function func() {
  // 没有声明变量的关键字，name 被挂载在当前的 Window 对象下
  name = 'peter';
  return `${name} is a dog.`;
}

func();
```

* 程序中不能再访问到的对象

```javascript
function func() {
  // 增加声明变量的关键字，当函数调用结束后，在外部空间就不能访问到 name 了
  const name = 'peter';
  return `${name} is a dog.`;
}

func();
```

在垃圾回收器进行工作的时候，如何查找垃圾、怎样释放空间、回收空间时如何进行分配，这一系列过程中遵循的规则，就是 GC 算法。

常见的 GC 算法有：

* 引用计数：通过一个数字判断当前对象是不是垃圾。
* 标记清除：在 GC 工作时给活动对象添加一个标记，来判断它是否是一个垃圾。
* 标记整理：同标记清除，但在后续回收过程中可以做一些不同的事情。
* 分代回收：V8 中的回收机制。

### 引用计数算法实现原理

核心思想：在内部通过一个引用计数器，维护当前对象的引用数。在引用关系改变时修改引用计数器的数字。当这个数值为 0 的时候，GC 开始工作，将其所在的对象空间进行回收和释放。

引用计数算法优点：

* 发现垃圾时能立即回收
* 最大限度减少程序暂停（能尽可能保证内存不会有占满的时候）

引用计数算法缺点：

* 无法回收循环引用的对象
```javascript
function fn() {
  const obj1 = {};
  const obj2 = {};
  obj1.name = obj2;
  obj2.name = obj1;
  return 'peter is a dog.';
}

// 函数调用完后，虽然全局作用域内找不到 obj1 和 obj2
// 但由于他们两者之间有互相指引关系，所以引用计数器数值不为 0，因此空间无法回收
fn()
```
* 时间开销大（需要时刻监控当前对象的引用数值）

### 标记清除算法实现原理

核心思想：将整个垃圾回收操作分成「标记」和「清除」二个阶段完成。

第一个阶段会遍历所有对象，找出活动对象（可达对象）并标记。第二个阶段仍是遍历所有对象，清除没有标记的对象，同时消除在第一阶段设置的标记，便于 GC 下一次的正常工作。

经过两个阶段的遍历行为，可以回收相应的空间，交给空闲列表维护以供后续的程序代码使用。

标记清除算法优点：

* 可以回收循环引用的对象（例如函数局部作用域内互相引用的变量，当函数调用结束之后，局部空间的变量失去了与全局空间在作用域上的连接，成为了不可达对象，在标记阶段就无法完成标记，在清除阶段会被清除）

标记清除算法缺点：

* 空间的碎片化（由于当前所回收的垃圾对象在地址上本身是不连续的，在回收之后它们会分散在各个角落，后续使用的时候如果新的生成空间刚好大小匹配就可以直接用，如果多了或者少了就不太适合使用了）

### 标记整理算法实现原理

核心思想：标记整理可以看作是标记清除的增强。标记阶段的操作和标记清除一致，清除阶段会先执行整理，移动对象位置（让它们在地址上产生连续）。

<div style="margin: auto; width: 600px;">
  <img src="./assets/gc-mark-compact.png" alt="标记整理算法图示">
  <p style="text-align: center; color: #888">（标记整理算法图示）</p>
</div>
