# TCP 协议

## TCP 包头

TCP 包头比 UDP 复杂得多。

<div style="text-align: center;">
  <svg id="SvgjsSvg1240" width="835" height="423.1750030517578" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs"><defs id="SvgjsDefs1241"></defs><g id="SvgjsG1242" transform="translate(25.000015258789062,25)"><path id="SvgjsPath1243" d="M0 0L389.2815 0L389.2815 50 L0 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1244" d="M389.2815 0L785 0L785 50 L389.2815 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1245"><text id="SvgjsText1246" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="390px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="14.375" transform="rotate(0)"><tspan id="SvgjsTspan1247" dy="16" x="195"><tspan id="SvgjsTspan1248" style="text-decoration:;">源端口号（16 位）</tspan></tspan></text></g><g id="SvgjsG1249"><text id="SvgjsText1250" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="396px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="14.375" transform="rotate(0)"><tspan id="SvgjsTspan1251" dy="16" x="587.2815"><tspan id="SvgjsTspan1252" style="text-decoration:;">目的端口号（16 位）</tspan></tspan></text></g></g><g id="SvgjsG1253" transform="translate(25.000015258789062,318.1805969482423)"><path id="SvgjsPath1254" d="M0 0L785 0L785 80 L0 80Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1255"><text id="SvgjsText1256" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="785px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="29.375" transform="rotate(0)"><tspan id="SvgjsTspan1257" dy="16" x="392.5"><tspan id="SvgjsTspan1258" style="text-decoration:;">数据</tspan></tspan></text></g></g><g id="SvgjsG1259" transform="translate(25.000015258789062,73.79999923706055)"><path id="SvgjsPath1260" d="M0 0L785 0L785 50.10000038146973 L0 50.10000038146973Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1261" d="M0 50.10000038146973L785 50.10000038146973L785 100.20000076293945 L0 100.20000076293945Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1262"><text id="SvgjsText1263" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="785px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="14.425000190734863" transform="rotate(0)"><tspan id="SvgjsTspan1264" dy="16" x="392.5"><tspan id="SvgjsTspan1265" style="text-decoration:;">序号（32 位）</tspan></tspan></text></g><g id="SvgjsG1266"><text id="SvgjsText1267" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="785px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="64.52500057220459" transform="rotate(0)"><tspan id="SvgjsTspan1268" dy="16" x="392.5"><tspan id="SvgjsTspan1269" style="text-decoration:;">确认序号（32 位）</tspan></tspan></text></g></g><g id="SvgjsG1270" transform="translate(25.000015258789062,174.09029847412114)"><path id="SvgjsPath1271" d="M0 0L119.00600000000001 0L119.00600000000001 50 L0 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1272" d="M119.00600000000001 0L229.76950000000002 0L229.76950000000002 50 L119.00600000000001 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1273" d="M229.69100000000003 0L256.45950000000005 0L256.45950000000005 50 L229.69100000000003 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1274" d="M256.4595 0L281.7365 0L281.7365 50 L256.4595 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1275" d="M281.815 0L309.8395 0L309.8395 50 L281.815 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1276" d="M309.8395 0L337.4715 0L337.4715 50 L309.8395 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1277" d="M337.4715 0L365.2605 0L365.2605 50 L337.4715 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1278" d="M365.2605 0L391.24399999999997 0L391.24399999999997 50 L365.2605 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1279" d="M391.3225 0L785 0L785 50 L391.3225 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1280"><text id="SvgjsText1281" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="120px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="14.375" transform="rotate(0)"><tspan id="SvgjsTspan1282" dy="16" x="60"><tspan id="SvgjsTspan1283" style="text-decoration:;">首部长度（4 位）</tspan></tspan></text></g><g id="SvgjsG1284"><text id="SvgjsText1285" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="111px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="14.375" transform="rotate(0)"><tspan id="SvgjsTspan1286" dy="16" x="174.50600000000003"><tspan id="SvgjsTspan1287" style="text-decoration:;">保留（6 位）</tspan></tspan></text></g><g id="SvgjsG1288"><text id="SvgjsText1289" font-family="微软雅黑" text-anchor="middle" font-size="12px" width="27px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="12px" weight="400" font-style="" opacity="1" y="0" transform="rotate(0)"><tspan id="SvgjsTspan1290" dy="15" x="243.19100000000003"><tspan id="SvgjsTspan1291" style="text-decoration:;">U</tspan></tspan><tspan id="SvgjsTspan1292" dy="15" x="243.19100000000003"><tspan id="SvgjsTspan1293" style="text-decoration:;font-size: inherit;">R</tspan></tspan><tspan id="SvgjsTspan1294" dy="15" x="243.19100000000003"><tspan id="SvgjsTspan1295" style="text-decoration:;">G</tspan></tspan></text></g><g id="SvgjsG1296"><text id="SvgjsText1297" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="26px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-2.125" transform="rotate(0)"><tspan id="SvgjsTspan1298" dy="16" x="269.4595"><tspan id="SvgjsTspan1299" style="text-decoration:;">A</tspan></tspan><tspan id="SvgjsTspan1300" dy="16" x="269.4595"><tspan id="SvgjsTspan1301" style="text-decoration:;font-size: inherit;">C</tspan></tspan><tspan id="SvgjsTspan1302" dy="16" x="269.4595"><tspan id="SvgjsTspan1303" style="text-decoration:;">K</tspan></tspan></text></g><g id="SvgjsG1304"><text id="SvgjsText1305" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="29px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-2.125" transform="rotate(0)"><tspan id="SvgjsTspan1306" dy="16" x="296.315"><tspan id="SvgjsTspan1307" style="text-decoration:;">P</tspan></tspan><tspan id="SvgjsTspan1308" dy="16" x="296.315"><tspan id="SvgjsTspan1309" style="text-decoration:;">S</tspan></tspan><tspan id="SvgjsTspan1310" dy="16" x="296.315"><tspan id="SvgjsTspan1311" style="text-decoration:;">H</tspan></tspan></text></g><g id="SvgjsG1312"><text id="SvgjsText1313" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="28px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-2.125" transform="rotate(0)"><tspan id="SvgjsTspan1314" dy="16" x="323.8395"><tspan id="SvgjsTspan1315" style="text-decoration:;">R</tspan></tspan><tspan id="SvgjsTspan1316" dy="16" x="323.8395"><tspan id="SvgjsTspan1317" style="text-decoration:;">S</tspan></tspan><tspan id="SvgjsTspan1318" dy="16" x="323.8395"><tspan id="SvgjsTspan1319" style="text-decoration:;">T</tspan></tspan></text></g><g id="SvgjsG1320"><text id="SvgjsText1321" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="28px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-2.125" transform="rotate(0)"><tspan id="SvgjsTspan1322" dy="16" x="351.4715"><tspan id="SvgjsTspan1323" style="text-decoration:;">S</tspan></tspan><tspan id="SvgjsTspan1324" dy="16" x="351.4715"><tspan id="SvgjsTspan1325" style="text-decoration:;">Y</tspan></tspan><tspan id="SvgjsTspan1326" dy="16" x="351.4715"><tspan id="SvgjsTspan1327" style="text-decoration:;">N</tspan></tspan></text></g><g id="SvgjsG1328"><text id="SvgjsText1329" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="26px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="-2.125" transform="rotate(0)"><tspan id="SvgjsTspan1330" dy="16" x="378.2605"><tspan id="SvgjsTspan1331" style="text-decoration:;">F</tspan></tspan><tspan id="SvgjsTspan1332" dy="16" x="378.2605"><tspan id="SvgjsTspan1333" style="text-decoration:;">I</tspan></tspan><tspan id="SvgjsTspan1334" dy="16" x="378.2605"><tspan id="SvgjsTspan1335" style="text-decoration:;">N</tspan></tspan></text></g><g id="SvgjsG1336"><text id="SvgjsText1337" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="394px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="14.375" transform="rotate(0)"><tspan id="SvgjsTspan1338" dy="16" x="588.3225"><tspan id="SvgjsTspan1339" style="text-decoration:;">窗口大小（16 位）</tspan></tspan></text></g></g><g id="SvgjsG1340" transform="translate(25.000015258789062,223.59029847412114)"><path id="SvgjsPath1341" d="M0 0L392.5 0L392.5 50 L0 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1342" d="M392.5 0L785 0L785 50 L392.5 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1343"><text id="SvgjsText1344" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="393px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="14.375" transform="rotate(0)"><tspan id="SvgjsTspan1345" dy="16" x="196.5"><tspan id="SvgjsTspan1346" style="text-decoration:;">校验和（16 位）</tspan></tspan></text></g><g id="SvgjsG1347"><text id="SvgjsText1348" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="393px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="14.375" transform="rotate(0)"><tspan id="SvgjsTspan1349" dy="16" x="589"><tspan id="SvgjsTspan1350" style="text-decoration:;">紧急指针（16 位）</tspan></tspan></text></g></g><g id="SvgjsG1351" transform="translate(25.000015258789062,272.5999984741211)"><path id="SvgjsPath1352" d="M0 0L785 0L785 50 L0 50Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1353"><text id="SvgjsText1354" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="785px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="14.375" transform="rotate(0)"><tspan id="SvgjsTspan1355" dy="16" x="392.5"><tspan id="SvgjsTspan1356" style="text-decoration:;">选项</tspan></tspan></text></g></g></svg>
  <p style="text-align: center; color: #888;">（TCP 包头示意图）</p>
</div>

* **源端口号**和**目标端口号**：可以知道把数据发给哪个应用。
* **包的序号**：为了解决乱序的问题。
* **确认序号**：为了解决丢包的问题。确认发出去的包对方有没有收到，如果没有收到就重新发送，直到送达。
* **一些状态位**：TCP 是面向连接的，因而双方要维护连接的状态，这些带状态位的包的发送，会引起双方的状态变更。例如 SYN（synchronous）是发起一个连接，ACK（acknowledgement）是确认，PSH（push）是传送，FIN（finish）是结束连接，RST（reset）是重新连接，URG（urgent）是紧急等。
* **窗口大小**：TCP 要做流量控制，通信双方各声明一个窗口，标识自己当前能够的处理能力，防止发送的太快或太慢。

总的来说，TCP 是尽可能地在自己的层面上保证可靠性。因为如果更底层的 IP 层面网络状况就很差，那么是没有任何可靠性保证的。对于 TCP 来说，就是 IP 层你丢不丢包，我管不着，但在我的层面上，可以通过不断重传，通过各种算法，努力保证可靠性。

## TCP 的三次握手

TCP 的连接建立，常常称为三次握手。在连接建立的过程中，双方的状态变化时序图就像这样：

<div style="text-align: center;">
  <svg id="SvgjsSvg1006" width="608" height="445" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs"><defs id="SvgjsDefs1007"><marker id="SvgjsMarker1059" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1060" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1067" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1068" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1075" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1076" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1083" markerWidth="14" markerHeight="10" refX="4" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1084" d="M14,0 L0,5 L14,10 L14,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker><marker id="SvgjsMarker1085" markerWidth="14" markerHeight="10" refX="10" refY="5" viewBox="0 0 14 10" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1086" d="M0,0 L14,5 L0,10 L0,0" fill="#323232" stroke="#323232" stroke-width="1"></path></marker></defs><g id="SvgjsG1008" transform="translate(25,65)"><path id="SvgjsPath1009" d="M0 0L140 0L140 40.00773364 L0 40.00773364Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1010" d="M0 40.00773364L140 40.00773364L140 193.04530216 L0 193.04530216Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1011" d="M0 193.00980284L140 193.00980284L140 354.9932 L0 354.9932Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1012"><text id="SvgjsText1013" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6.003866819999999" transform="rotate(0)"><tspan id="SvgjsTspan1014" dy="20" x="70"><tspan id="SvgjsTspan1015" style="text-decoration:;">CLOSED</tspan></tspan></text></g><g id="SvgjsG1016"><text id="SvgjsText1017" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="102.5265179" transform="rotate(0)"><tspan id="SvgjsTspan1018" dy="20" x="70"><tspan id="SvgjsTspan1019" style="text-decoration:;">SYN_SENT</tspan></tspan></text></g><g id="SvgjsG1020"><text id="SvgjsText1021" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="260.00150142" transform="rotate(0)"><tspan id="SvgjsTspan1022" dy="20" x="70"><tspan id="SvgjsTspan1023" style="text-decoration:;">ESTABLISHED</tspan></tspan></text></g></g><g id="SvgjsG1024" transform="translate(443,65)"><path id="SvgjsPath1025" d="M0 0L140 0L140 40.01570307 L0 40.01570307Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1026" d="M0 40.01570307L140 40.01570307L140 83.02290549 L0 83.02290549Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1027" d="M0 83.02290549L140 83.02290549L140 244.98619971 L0 244.98619971Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><path id="SvgjsPath1028" d="M0 244.98619971000002L140 244.98619971000002L140 351.9411 L0 351.9411Z" stroke="rgba(102, 102, 102,1)" stroke-width="1" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1029"><text id="SvgjsText1030" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6.007851535" transform="rotate(0)"><tspan id="SvgjsTspan1031" dy="20" x="70"><tspan id="SvgjsTspan1032" style="text-decoration:;">CLOSED</tspan></tspan></text></g><g id="SvgjsG1033"><text id="SvgjsText1034" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="47.51930428" transform="rotate(0)"><tspan id="SvgjsTspan1035" dy="20" x="70"><tspan id="SvgjsTspan1036" style="text-decoration:;">LISTEN</tspan></tspan></text></g><g id="SvgjsG1037"><text id="SvgjsText1038" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="150.0045526" transform="rotate(0)"><tspan id="SvgjsTspan1039" dy="20" x="70"><tspan id="SvgjsTspan1040" style="text-decoration:;">SYN_RCVD</tspan></tspan></text></g><g id="SvgjsG1041"><text id="SvgjsText1042" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="140px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="284.463649855" transform="rotate(0)"><tspan id="SvgjsTspan1043" dy="20" x="70"><tspan id="SvgjsTspan1044" style="text-decoration:;">ESTABLISHED</tspan></tspan></text></g></g><g id="SvgjsG1045" transform="translate(34,25)"><path id="SvgjsPath1046" d="M 0 0L 120 0L 120 40L 0 40Z" stroke="none" fill="none"></path><g id="SvgjsG1047"><text id="SvgjsText1048" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="120px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6" transform="rotate(0)"><tspan id="SvgjsTspan1049" dy="20" x="60"><tspan id="SvgjsTspan1050" style="text-decoration:;">客户端</tspan></tspan></text></g></g><g id="SvgjsG1051" transform="translate(454,25)"><path id="SvgjsPath1052" d="M 0 0L 120 0L 120 40L 0 40Z" stroke="none" fill="none"></path><g id="SvgjsG1053"><text id="SvgjsText1054" font-family="微软雅黑" text-anchor="middle" font-size="16px" width="120px" fill="#323232" font-weight="400" align="middle" lineHeight="125%" anchor="middle" family="微软雅黑" size="16px" weight="400" font-style="" opacity="1" y="6" transform="rotate(0)"><tspan id="SvgjsTspan1055" dy="20" x="60"><tspan id="SvgjsTspan1056" style="text-decoration:;">服务端</tspan></tspan></text></g></g><g id="SvgjsG1057"><path id="SvgjsPath1058" d="M165.49438963502843 105.0746919592489L439.93478426282365 146.5369098526568" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1059)"></path><rect id="SvgjsRect1061" width="71" height="16" x="267.214586948926" y="117.80580090595285" fill="#ffffff"></rect><text id="SvgjsText1062" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="71px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="115.18080090595285" transform="rotate(0)"><tspan id="SvgjsTspan1063" dy="16" x="302.714586948926"><tspan id="SvgjsTspan1064" style="text-decoration:;">SYN, seq=x</tspan></tspan></text></g><g id="SvgjsG1065"><path id="SvgjsPath1066" d="M442.5322515933258 151.1766675636719L167.9000401213799 254.9046611052342" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1067)"></path><rect id="SvgjsRect1069" width="165" height="16" x="222.71614585735284" y="195.04066433445306" fill="#ffffff"></rect><text id="SvgjsText1070" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="165px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="192.41566433445306" transform="rotate(0)"><tspan id="SvgjsTspan1071" dy="16" x="305.21614585735284"><tspan id="SvgjsTspan1072" style="text-decoration:;">SYN, ACK, seq=y, ack=x+1</tspan></tspan></text></g><g id="SvgjsG1073"><path id="SvgjsPath1074" d="M165.4917928161331 259.09022098425464L439.9508845399748 309.44062989762125" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1075)"></path><rect id="SvgjsRect1077" width="150" height="16" x="227.72133867805394" y="276.265425440938" fill="#ffffff"></rect><text id="SvgjsText1078" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="150px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="273.640425440938" transform="rotate(0)"><tspan id="SvgjsTspan1079" dy="16" x="302.72133867805394"><tspan id="SvgjsTspan1080" style="text-decoration:;">ACK, seq=x+1, ack=y+1</tspan></tspan></text></g><g id="SvgjsG1081"><path id="SvgjsPath1082" d="M168.10000000000002 395L439.9 395" stroke="#323232" stroke-width="2" fill="none" marker-start="url(#SvgjsMarker1083)" marker-end="url(#SvgjsMarker1085)"></path><rect id="SvgjsRect1087" width="52" height="16" x="278" y="387" fill="#ffffff"></rect><text id="SvgjsText1088" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="52px" fill="#323232" font-weight="400" align="top" lineHeight="16px" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="384.375" transform="rotate(0)"><tspan id="SvgjsTspan1089" dy="16" x="304"><tspan id="SvgjsTspan1090" style="text-decoration:;">数据传输</tspan></tspan></text></g></svg>
  <p style="text-align: center; color: #888;">（三次握手）</p>
</div>

一开始，客户端和服务端都处于 `CLOSED` 状态。

先是服务端主动监听某个端口，处于 `LISTEN` 状态。

* **第一次握手**：客户端主动发起连接 `SYN`，之后处于 `SYN_SENT`（同步已发送）状态。
* **第二次握手**：服务端收到发起的连接，返回 `SYN`，并且 `ACK` 客户端的 `SYN`，之后处于 `SYN_RCVD`（同步收到）状态。
* **第三次握手**：客户端收到服务端发送的 `SYN` 和 `ACK` 之后，发送 `ACK` 的 `ACK`，之后处于 `ESTABLISHED`（已建立连接）状态，因为它一发一收成功了。

最后，服务端收到 `ACK` 的 `ACK` 之后，处于 `ESTABLISHED`（已建立连接）状态，因为它也一发一收了。

::: tip 小贴士
在三次握手过程中：

* `seq` 是数据包本身的序列号，这是为了连接以后传送数据用的。
* `ack` 是对收到的数据包的确认，值是等待接收的数据包的序列号（也就是期望对方继续发送的那个数据包的序列号）。

在传递过程中它们是这样用的：

* 第一次消息：客户端会随机选取一个序列号（`x`）作为自己的初始序号发送给服务端。
* 第二次消息：服务端使用 ACK 对客户端的数据包进行确认，准备接收序列号为 `x+1` 的包，所以 `ack=x+1`。同时告诉客户端自己的初始序列号，就是 `seq=y`。
* 第三次消息：客户端告诉服务端收到了它的确认消息并准备建立连接，客户端自己此条消息的序列号是 `x+1`，所以 `seq=x+1`，而 `ack=y+1` 是表示客户端正准备接收服务端序列号为 `y+1` 的数据包。
:::

## TCP 的四次握手
